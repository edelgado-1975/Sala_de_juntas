{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Calendario{% endblock %}

{% block extra_css %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/locales/es.global.min.js"></script>

<style>
    .fc-event {
        cursor: pointer;
    }

    .filter-card {
        transition: all 0.3s ease;
    }

    @media (min-width: 992px) {
        .filter-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
    }

    /* Estilos para el calendario en movil */
    @media (max-width: 768px) {
        .fc .fc-toolbar {
            flex-direction: column;
            gap: 10px;
        }

        .fc-header-toolbar {
            margin-bottom: 1em !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar de Filtros e Informacion -->
    <!-- Botones de accion en movil -->
    <div class="col-12 d-lg-none mb-3">
        <div class="mb-2">
            <label class="form-label fw-bold small">Seleccionar Sala:</label>
            <select class="form-select mb-2" id="filtroSalaDirectoMobile">
                <option value="">Todas las salas</option>
                {% for sala in salas %}
                <option value="{{ sala.id }}">{{ sala.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="d-flex gap-2 mb-2">
            <button class="btn btn-outline-sena flex-grow-1" type="button" data-bs-toggle="offcanvas"
                data-bs-target="#offcanvasFilters">
                <i class="bi bi-funnel"></i> M치s Filtros
            </button>
            {% if not user.es_consulta %}
            <button class="btn btn-sena flex-grow-1" data-bs-toggle="modal" data-bs-target="#nuevaReservaModal">
                <i class="bi bi-plus-circle"></i> Nueva Reserva
            </button>
            {% endif %}
        </div>
        <!-- Convenciones compactas en movil -->
        <div class="card shadow-sm border-0 bg-light">
            <div class="card-body py-2 px-3">
                <div class="d-flex justify-content-between align-items-center small">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle me-1" style="width: 10px; height: 10px; background-color: #39A900;">
                        </div>
                        <span>Confirmada</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle me-1" style="width: 10px; height: 10px; background-color: #FFC107;">
                        </div>
                        <span>Pendiente</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle me-1" style="width: 10px; height: 10px; background-color: #DC3545;">
                        </div>
                        <span>Cancelada</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar de Filtros e Informacion (Desktop) -->
    <div class="col-lg-3 d-none d-lg-block">
        <div class="card shadow-sm mb-4 filter-card">
            <div class="card-header bg-white">
                <h5 class="mb-0 text-sena"><i class="bi bi-funnel"></i> Filtros</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Sala</label>
                    <select class="form-select" id="filtroSala">
                        <option value="">Todas las salas</option>
                        {% for sala in salas %}
                        <option value="{{ sala.id }}">{{ sala.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Estado</label>
                    <select class="form-select" id="filtroEstado">
                        <option value="">Todos los estados</option>
                        <option value="CONFIRMADA">Confirmada</option>
                        <option value="PENDIENTE">Pendiente</option>
                        <option value="CANCELADA">Cancelada</option>
                    </select>
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-sena btn-sm" id="btnFiltrar">
                        <i class="bi bi-search"></i> Filtrar
                    </button>
                    <button class="btn btn-link text-muted btn-sm" id="btnLimpiar">
                        Limpiar filtros
                    </button>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0 text-sena"><i class="bi bi-info-circle"></i> Convenciones</h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    <div class="rounded-circle me-2" style="width: 15px; height: 15px; background-color: #39A900;">
                    </div>
                    <span>Confirmada</span>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <div class="rounded-circle me-2" style="width: 15px; height: 15px; background-color: #FFC107;">
                    </div>
                    <span>Pendiente</span>
                </div>
                <div class="d-flex align-items-center mb-0">
                    <div class="rounded-circle me-2" style="width: 15px; height: 15px; background-color: #DC3545;">
                    </div>
                    <span>Cancelada</span>
                </div>
            </div>
        </div>

        {% if not user.es_consulta %}
        <div class="d-grid">
            <button class="btn btn-sena btn-lg shadow-sm" data-bs-toggle="modal" data-bs-target="#nuevaReservaModal">
                <i class="bi bi-plus-circle"></i> Nueva Reserva
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Offcanvas para Filtros (Movil) -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasFilters" aria-labelledby="offcanvasFiltersLabel">
        <div class="offcanvas-header bg-sena text-white">
            <h5 class="offcanvas-title" id="offcanvasFiltersLabel">Filtros e Informaci칩n</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"
                aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <!-- Mismo contenido que el sidebar de desktop -->
            <div class="mb-4">
                <h6 class="fw-bold"><i class="bi bi-funnel"></i> Filtrar Reservas</h6>
                <div class="mb-3">
                    <label class="form-label">Sala</label>
                    <select class="form-select" id="filtroSalaMobile">
                        <option value="">Todas las salas</option>
                        {% for sala in salas %}
                        <option value="{{ sala.id }}">{{ sala.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Estado</label>
                    <select class="form-select" id="filtroEstadoMobile">
                        <option value="">Todos los estados</option>
                        <option value="CONFIRMADA">Confirmada</option>
                        <option value="PENDIENTE">Pendiente</option>
                        <option value="CANCELADA">Cancelada</option>
                    </select>
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-sena" id="btnFiltrarMobile">
                        <i class="bi bi-search"></i> Aplicar Filtros
                    </button>
                </div>
            </div>

            <hr>

            <div class="mb-4">
                <h6 class="fw-bold"><i class="bi bi-info-circle"></i> Convenciones</h6>
                <div class="d-flex align-items-center mb-2">
                    <div class="rounded-circle me-2" style="width: 15px; height: 15px; background-color: #39A900;">
                    </div>
                    <span>Confirmada</span>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <div class="rounded-circle me-2" style="width: 15px; height: 15px; background-color: #FFC107;">
                    </div>
                    <span>Pendiente</span>
                </div>
                <div class="d-flex align-items-center">
                    <div class="rounded-circle me-2" style="width: 15px; height: 15px; background-color: #DC3545;">
                    </div>
                    <span>Cancelada</span>
                </div>
            </div>

            {% if not user.es_consulta %}
            <div class="d-grid">
                <button class="btn btn-sena btn-lg" data-bs-toggle="modal" data-bs-target="#nuevaReservaModal"
                    data-bs-dismiss="offcanvas">
                    <i class="bi bi-plus-circle"></i> Nueva Reserva
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Calendario -->
    <div class="col-lg-9">
        <div class="card shadow-sm h-100">
            <div class="card-body p-0">
                <div id='calendar' class="p-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalles Reserva -->
<div class="modal fade" id="eventoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-sena text-white">
                <h5 class="modal-title" id="eventoTitulo">Detalles de la Reserva</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Sala:</strong> <span id="eventoSala"></span></p>
                <p><strong>Usuario:</strong> <span id="eventoUsuario"></span></p>
                <p><strong>Horario:</strong> <span id="eventoHorario"></span></p>
                <p><strong>Estado:</strong> <span id="eventoEstado" class="badge"></span></p>
                <div class="alert alert-light border" id="eventoDescripcionContainer">
                    <strong>Descripcion:</strong>
                    <p class="mb-0" id="eventoDescripcion"></p>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <div>
                    <a href="#" id="btnExportarReserva" class="btn btn-outline-primary mb-1">
                        <i class="bi bi-calendar-event me-1"></i>Exportar .ics
                    </a>
                    <a href="#" id="btnEditarReserva" class="btn btn-primary d-none mb-1">
                        <i class="bi bi-pencil"></i> Editar
                    </a>
                    <a href="#" id="btnEliminarReserva" class="btn btn-danger d-none mb-1">
                        <i class="bi bi-trash"></i> Cancelar
                    </a>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Reserva -->
<div class="modal fade" id="nuevaReservaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-sena text-white">
                <h5 class="modal-title">Crear Nueva Reserva</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="modal-body">
                    {% if form.errors %}
                    <div class="alert alert-danger">
                        Corrija los errores indicados.
                    </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Sala</label>
                            {{ form.sala }}
                            {% if form.sala.errors %}
                            <div class="text-danger small">{{ form.sala.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Numero de Asistentes</label>
                            {{ form.num_asistentes }}
                            {% if form.num_asistentes.errors %}
                            <div class="text-danger small">{{ form.num_asistentes.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha Inicio</label>
                            {{ form.fecha_inicio }}
                            {% if form.fecha_inicio.errors %}
                            <div class="text-danger small">{{ form.fecha_inicio.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha Fin</label>
                            {{ form.fecha_fin }}
                            {% if form.fecha_fin.errors %}
                            <div class="text-danger small">{{ form.fecha_fin.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Prop칩sito</label>
                        {{ form.proposito }}
                        {% if form.proposito.errors %}
                        <div class="text-danger small">{{ form.proposito.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Estado</label>
                            {{ form.estado }}
                            {% if form.estado.errors %}
                            <div class="text-danger small">{{ form.estado.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Descripcion (Opcional)</label>
                        {{ form.descripcion }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-sena">Crear Reserva</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');

        // Elementos de filtros (Desktop)
        var filtroSala = document.getElementById('filtroSala');
        var filtroEstado = document.getElementById('filtroEstado');
        var btnFiltrar = document.getElementById('btnFiltrar');
        var btnLimpiar = document.getElementById('btnLimpiar');

        // Elementos de filtros (Mobile)
        var filtroSalaMobile = document.getElementById('filtroSalaMobile');
        var filtroEstadoMobile = document.getElementById('filtroEstadoMobile');
        var btnFiltrarMobile = document.getElementById('btnFiltrarMobile');

        function getInitialView() {
            return window.innerWidth < 768 ? 'listWeek' : 'dayGridMonth';
        }

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: getInitialView(),
            locale: 'es',
            handleWindowResize: true,
            windowResize: function (arg) {
                if (window.innerWidth < 768) {
                    calendar.changeView('listWeek');
                } else {
                    calendar.changeView('dayGridMonth');
                }
            },
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            themeSystem: 'bootstrap5',
            navLinks: true,
            editable: false,
            dayMaxEvents: true,
            events: {
                url: "{% url 'reservas:api_eventos' %}",
                extraParams: function () {
                    return {
                        sala_id: filtroSala.value,
                        estado: filtroEstado.value
                    };
                }
            },
            selectable: true,
            select: function (info) {
                var isConsulta = '{{ user.es_consulta|yesno:"true,false" }}' === 'true';
                if (isConsulta) return;

                // Limpiar el formulario y preparar el modal
                var modal = new bootstrap.Modal(document.getElementById('nuevaReservaModal'));
                document.getElementById('id_fecha_inicio').value = info.startStr.slice(0, 16);
                document.getElementById('id_fecha_fin').value = info.endStr.slice(0, 16);

                // Pre-seleccionar la sala si hay un filtro de sala activo
                var selectedSala = filtroSala.value || (document.getElementById('filtroSalaDirectoMobile') ? document.getElementById('filtroSalaDirectoMobile').value : "");
                if (selectedSala) {
                    var salaField = document.getElementById('id_sala');
                    if (salaField) salaField.value = selectedSala;
                }

                modal.show();
            },
            eventClick: function (info) {
                var props = info.event.extendedProps;
                document.getElementById('eventoTitulo').textContent = info.event.title;
                document.getElementById('eventoSala').textContent = props.sala;
                document.getElementById('eventoUsuario').textContent = props.usuario;
                document.getElementById('eventoDescripcion').textContent = props.descripcion || 'Sin descripci칩n';

                var start = info.event.start.toLocaleString();
                var end = info.event.end ? info.event.end.toLocaleString() : '';
                document.getElementById('eventoHorario').textContent = start + ' - ' + end;

                var estadoEl = document.getElementById('eventoEstado');
                estadoEl.textContent = props.estado;
                estadoEl.className = 'badge';
                if (props.estado === 'PENDIENTE') {
                    estadoEl.classList.add('bg-warning', 'text-dark');
                } else if (props.estado === 'CONFIRMADA') {
                    estadoEl.classList.add('bg-success');
                } else {
                    estadoEl.classList.add('bg-secondary');
                }

                var btnEditar = document.getElementById('btnEditarReserva');
                var btnEliminar = document.getElementById('btnEliminarReserva');
                var btnExportar = document.getElementById('btnExportarReserva');

                var currentUserId = parseInt("{{ request.user.id }}");
                var isSuper = '{{ request.user.es_superusuario|yesno:"true,false" }}' === 'true';
                var isOperativo = '{{ request.user.es_operativo|yesno:"true,false" }}' === 'true';

                btnExportar.href = "/reservas/exportar/" + info.event.id + "/";

                if (isSuper || (isOperativo && props.usuario_id === currentUserId)) {
                    btnEditar.classList.remove('d-none');
                    btnEliminar.classList.remove('d-none');
                    btnEditar.href = "/reservas/editar/" + info.event.id + "/";
                    btnEliminar.href = "/reservas/eliminar/" + info.event.id + "/";
                } else {
                    btnEditar.classList.add('d-none');
                    btnEliminar.classList.add('d-none');
                }

                var modal = new bootstrap.Modal(document.getElementById('eventoModal'));
                modal.show();
            }
        });

        calendar.render();

        const filtroSalaDirectoMobile = document.getElementById('filtroSalaDirectoMobile');

        // Sincronizar filtros Desktop -> Mobile
        filtroSala.addEventListener('change', function () {
            filtroSalaMobile.value = this.value;
            filtroSalaDirectoMobile.value = this.value;
        });
        filtroEstado.addEventListener('change', function () { filtroEstadoMobile.value = this.value; });

        // Sincronizar filtros Mobile -> Desktop
        filtroSalaMobile.addEventListener('change', function () {
            filtroSala.value = this.value;
            filtroSalaDirectoMobile.value = this.value;
        });
        filtroEstadoMobile.addEventListener('change', function () { filtroEstado.value = this.value; });

        // Evento para el selector directo de movil
        filtroSalaDirectoMobile.addEventListener('change', function () {
            filtroSala.value = this.value;
            filtroSalaMobile.value = this.value;
            aplicarFiltros();
        });

        function aplicarFiltros() {
            calendar.refetchEvents();
        }

        btnFiltrar.addEventListener('click', aplicarFiltros);
        btnFiltrarMobile.addEventListener('click', function () {
            aplicarFiltros();
            bootstrap.Offcanvas.getInstance(document.getElementById('offcanvasFilters')).hide();
        });

        btnLimpiar.addEventListener('click', function () {
            filtroSala.value = "";
            filtroEstado.value = "";
            filtroSalaMobile.value = "";
            filtroEstadoMobile.value = "";
            if (filtroSalaDirectoMobile) filtroSalaDirectoMobile.value = "";
            calendar.refetchEvents();
        });

        {% if form.errors %}
        var myModal = new bootstrap.Modal(document.getElementById('nuevaReservaModal'));
        myModal.show();
        {% endif %}
    });
</script>
{% endblock %}